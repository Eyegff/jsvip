// р╕Щр╕│р╣Ар╕Вр╣Йр╕▓р╣Вр╕бр╕Фр╕╣р╕ер╕Чр╕╡р╣Ир╕Ир╕│р╣Ар╕Ыр╣Зр╕Щ
const TelegramBot = require('node-telegram-bot-api');
const request = require('request').defaults({ jar: true });
const { v4: uuidv4 } = require('uuid');
const fs = require('fs');

// р╣Гр╕кр╣Ир╣Вр╕Чр╣Ар╕Др╕Щр╕Ър╕нр╕Ч Telegram р╕Вр╕нр╕Зр╕Др╕╕р╕Ур╕Чр╕╡р╣Ир╕Щр╕╡р╣И
const token = ''; // р╣Бр╕Чр╕Щр╕Чр╕╡р╣Ир╕Фр╣Йр╕зр╕вр╣Вр╕Чр╣Ар╕Др╕Щр╕Вр╕нр╕Зр╕Др╕╕р╕У

// р╕кр╕гр╣Йр╕▓р╕Зр╕Ър╕нр╕Чр╕Чр╕╡р╣Ир╣Гр╕Кр╣Й 'polling' р╣Гр╕Щр╕Бр╕▓р╕гр╕гр╕▒р╕Ър╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╣Гр╕лр╕бр╣И
const bot = new TelegramBot(token, { polling: true });

// р╣Ар╕Бр╣Зр╕Ър╕кр╕Цр╕▓р╕Щр╕░р╕Вр╕нр╕Зр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╣Гр╕Щр╕Бр╕▓р╕гр╕кр╕Щр╕Чр╕Щр╕▓
const userSessions = {};

// р╣Ар╕Ър╕нр╕гр╣Мр╕бр╕╖р╕нр╕Цр╕╖р╕нр╕Чр╕╡р╣Ир╣Гр╕Кр╣Йр╣Гр╕Щр╕Бр╕▓р╕гр╕гр╕▒р╕Ър╣Ар╕Зр╕┤р╕Щ
const mobileNumber = '0825658423';

// р╣Ар╕Бр╣Зр╕Ър╕Кр╕╖р╣Ир╕нр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╕Вр╕нр╕Зр╕Ър╕нр╕Ч
let botUsername = '';
bot.getMe().then((botInfo) => {
  botUsername = botInfo.username;
});

// р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╕кр╕│р╕лр╕гр╕▒р╕Ър╣Бр╕гр╕Щр╕Фр╕нр╕б UUID
function generateUUID() {
  return uuidv4();
}

// р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╕кр╕│р╕лр╕гр╕▒р╕Ър╕кр╕гр╣Йр╕▓р╕Зр╣Ар╕зр╕ер╕▓ expiryTime (р╕Хр╕▓р╕бр╕Ир╕│р╕Щр╕зр╕Щр╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╕Бр╕│р╕лр╕Щр╕Ф)
function generateExpiryTime(days) {
  const now = new Date();
  const expiryDate = new Date(now.setDate(now.getDate() + days));
  return expiryDate.getTime();
}

// р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╕кр╕│р╕лр╕гр╕▒р╕Ър╣Ар╕Вр╣Йр╕▓р╕кр╕╣р╣Ир╕гр╕░р╕Ър╕Ъ
function login(callback) {
  const loginOptions = {
    method: 'POST',
    url: '/GaKtR4zXrqhyIpG/login',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded'
    },
    form: {
      'username': '',
      'password': ''
    }
  };

  request(loginOptions, function (error, response) {
    if (error) {
      console.error('р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╣Ар╕Вр╣Йр╕▓р╕кр╕╣р╣Ир╕гр╕░р╕Ър╕Ъ:', error);
      return;
    }
    try {
      const body = JSON.parse(response.body);
      if (body.success) {
        console.log('р╣Ар╕Вр╣Йр╕▓р╕кр╕╣р╣Ир╕гр╕░р╕Ър╕Ър╕кр╕│р╣Ар╕гр╣Зр╕И:', body.msg);
        callback(); // р╣Ар╕гр╕╡р╕вр╕Бр╣Гр╕Кр╣Йр╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╕Цр╕▒р╕Фр╣Др╕Ы
      } else {
        console.log('р╣Ар╕Вр╣Йр╕▓р╕кр╕╣р╣Ир╕гр╕░р╕Ър╕Ър╕ер╣Йр╕бр╣Ар╕лр╕ер╕з:', body.msg);
      }
    } catch (e) {
      console.error('р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Бр╕Ыр╕ер╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Бр╕▓р╕гр╕Хр╕нр╕Ър╕Бр╕ер╕▒р╕Ър╣Ар╕Ыр╣Зр╕Щ JSON р╣Др╕Фр╣Й:', e);
      console.log('Response Body:', response.body);
    }
  });
}

// р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╕кр╕│р╕лр╕гр╕▒р╕Ър╣Ар╕Юр╕┤р╣Ир╕бр╕ер╕╣р╕Бр╕Др╣Йр╕▓р╣Гр╕лр╕бр╣И
function addNewClient(session, successCallback, errorCallback) {
  const clientUUID = generateUUID();
  const expiryTime = generateExpiryTime(session.days);
  const totalGB = session.gbLimit > 0 ? session.gbLimit * 1024 * 1024 * 1024 : 0; // Convert GB to bytes

  const options = {
    method: 'POST',
    url: '/GaKtR4zXrqhyIpG/panel/api/inbounds/addClient',
    headers: {
      'Accept': 'application/json',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      id: 12,
      settings: JSON.stringify({
        clients: [{
          id: clientUUID,
          alterId: 0,
          email: session.codeName, // р╣Гр╕Кр╣Йр╕Кр╕╖р╣Ир╕нр╕Чр╕╡р╣Ир╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╕Хр╕▒р╣Йр╕З
          limitIp: 2,
          totalGB: totalGB > 0 ? totalGB : 0,
          expiryTime: expiryTime,
          enable: true,
          tgId: '',
          subId: ''
        }]
      })
    })
  };

  request(options, function (error, response) {
    if (error) {
      console.error('р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╕кр╣Ир╕Зр╕Др╕│р╕Вр╕н:', error);
      errorCallback('р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╕кр╣Ир╕Зр╕Др╕│р╕Вр╕н');
      return;
    }
    try {
      const body = JSON.parse(response.body);
      if (body.success) {
        console.log('р╣Ар╕Юр╕┤р╣Ир╕бр╕ер╕╣р╕Бр╕Др╣Йр╕▓р╕кр╕│р╣Ар╕гр╣Зр╕И:', body.msg);
        // р╕кр╕гр╣Йр╕▓р╕Зр╣Вр╕Др╣Йр╕Фр╕Хр╕▓р╕бр╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕г
        const clientCode = `vless://${clientUUID}@104.18.34.21:80?path=%2F&security=none&encryption=none&host=www.opensignal.com.esnfvpnfreevip_bot.itow.online&type=ws#${encodeURIComponent(session.codeName)}`;
        successCallback(clientCode);
      } else {
        console.log('р╕Бр╕▓р╕гр╣Ар╕Юр╕┤р╣Ир╕бр╕ер╕╣р╕Бр╕Др╣Йр╕▓р╕ер╣Йр╕бр╣Ар╕лр╕ер╕з:', body.msg);
        errorCallback(body.msg);
      }
    } catch (e) {
      console.error('р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Бр╕Ыр╕ер╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Бр╕▓р╕гр╕Хр╕нр╕Ър╕Бр╕ер╕▒р╕Ър╣Ар╕Ыр╣Зр╕Щ JSON р╣Др╕Фр╣Й:', e);
      console.log('Response Body:', response.body);
      errorCallback('р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Бр╕Ыр╕ер╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Бр╕▓р╕гр╕Хр╕нр╕Ър╕Бр╕ер╕▒р╕Ър╣Ар╕Ыр╣Зр╕Щ JSON р╣Др╕Фр╣Й');
    }
  });
}

// р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╕кр╕│р╕лр╕гр╕▒р╕Ър╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╕ер╕┤р╕Зр╕Бр╣Мр╕Лр╕нр╕Зр╕нр╕▒р╣Ир╕Зр╣Ар╕Ыр╕▓
function processTrueMoneyGiftCode(chatId, code) {
  const options = {
    method: 'POST',
    url: `https://gift.truemoney.com/campaign/vouchers/${code}/redeem`,
    headers: {
      'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)',
      'Accept': 'application/json',
      'Content-Type': 'application/json',
      'Origin': 'https://gift.truemoney.com',
      'Accept-Language': 'en-US,en;q=0.9',
      'Connection': 'keep-alive'
    },
    body: JSON.stringify({
      mobile: mobileNumber,
      voucher_hash: code
    })
  };

  request(options, function(error, response) {
    if (error) {
      console.error('р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╕кр╣Ир╕Зр╕Др╕│р╕Вр╕н:', error);
      bot.sendMessage(chatId, 'ЁЯЪл р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╕гр╕▒р╕Ър╣Ар╕Зр╕┤р╕Щ р╣Вр╕Ыр╕гр╕Фр╕ер╕нр╕Зр╣Гр╕лр╕бр╣Ир╕нр╕╡р╕Бр╕Др╕гр╕▒р╣Йр╕З');
      return;
    }

    if (response.statusCode === 200) {
      // р╣Бр╕Ыр╕ер╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Бр╕▓р╕гр╕Хр╕нр╕Ър╕Бр╕ер╕▒р╕Ър╣Ар╕Юр╕╖р╣Ир╕нр╕гр╕▒р╕Ър╕Ир╕│р╕Щр╕зр╕Щр╣Ар╕Зр╕┤р╕Щ
      try {
        const body = JSON.parse(response.body);
        if (body && body.data && body.data.my_ticket && body.data.my_ticket.amount_baht) {
          const amount = parseFloat(body.data.my_ticket.amount_baht);
          bot.sendMessage(chatId, `тЬЕ р╕гр╕▒р╕Ър╣Ар╕Зр╕┤р╕Щр╕Ир╕│р╕Щр╕зр╕Щ ${amount} р╕Ър╕▓р╕Ч р╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕вр╣Бр╕ер╣Йр╕з! р╕Вр╕нр╕Ър╕Др╕╕р╕Ур╕Чр╕╡р╣Ир╣Вр╕Фр╣Ар╕Щр╕Чр╕Др╕гр╕▒р╕Ъ ЁЯЩП`);
          // р╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╣Ар╕Др╕гр╕Фр╕┤р╕Хр╕Вр╕нр╕Зр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Й
          updateUserCredits(chatId, amount);
        } else {
          bot.sendMessage(chatId, 'ЁЯЪл р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╕гр╕▒р╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Ир╕│р╕Щр╕зр╕Щр╣Ар╕Зр╕┤р╕Щ');
        }
      } catch (e) {
        console.error('Error parsing response:', e);
        bot.sendMessage(chatId, 'ЁЯЪл р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕ер╕Вр╣Йр╕нр╕бр╕╣р╕е');
      }

    } else {
      console.log('Response:', response.body);
      bot.sendMessage(chatId, 'ЁЯЪл р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╕гр╕▒р╕Ър╣Ар╕Зр╕┤р╕Щ р╣Вр╕Ыр╕гр╕Фр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕ер╕┤р╕Зр╕Бр╣Мр╣Бр╕ер╕░р╕ер╕нр╕Зр╣Гр╕лр╕бр╣Ир╕нр╕╡р╕Бр╕Др╕гр╕▒р╣Йр╕З');
    }
  });
}

// р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╕кр╕│р╕лр╕гр╕▒р╕Ър╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╣Ар╕Др╕гр╕Фр╕┤р╕Хр╕Вр╕нр╕Зр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Й
let usersData = {};

// р╕Кр╕╖р╣Ир╕нр╣Др╕Яр╕ер╣Мр╕Чр╕╡р╣Ир╣Гр╕Кр╣Йр╣Ар╕Бр╣Зр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Ьр╕╣р╣Йр╣Гр╕Кр╣Й
const path = 'transactions.json';

// р╕нр╣Ир╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╕Ир╕▓р╕Бр╣Др╕Яр╕ер╣Мр╣Ар╕бр╕╖р╣Ир╕нр╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щр╣Вр╕Ыр╕гр╣Бр╕Бр╕гр╕б
if (fs.existsSync(path)) {
  // р╕Цр╣Йр╕▓р╣Др╕Яр╕ер╣Мр╕бр╕╡р╕нр╕вр╕╣р╣И р╣Гр╕лр╣Йр╕нр╣Ир╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Ир╕▓р╕Бр╣Др╕Яр╕ер╣М
  try {
    const data = fs.readFileSync(path, 'utf8');
    usersData = JSON.parse(data);
  } catch (err) {
    console.error('Error reading transactions.json:', err);
    usersData = {};
  }
} else {
  // р╕Цр╣Йр╕▓р╣Др╕Яр╕ер╣Мр╣Др╕бр╣Ир╕Юр╕Ъ р╣Гр╕лр╣Йр╕кр╕гр╣Йр╕▓р╕Зр╣Др╕Яр╕ер╣Мр╣Гр╕лр╕бр╣Ир╕Чр╕╡р╣Ир╕бр╕╡р╣Ар╕Щр╕╖р╣Йр╕нр╕лр╕▓р╣Ар╕Ыр╣Зр╕Щр╕нр╕нр╕Ър╣Ар╕Ир╕Бр╕Хр╣Мр╕зр╣Ир╕▓р╕З
  usersData = {};
  fs.writeFileSync(path, JSON.stringify(usersData, null, 2));
}

function getUserData(userId) {
  return usersData[userId] || { credits: 0, codes: [] };
}

function saveUserData(userId, data) {
  usersData[userId] = data;
  fs.writeFile(path, JSON.stringify(usersData, null, 2), (err) => {
    if (err) {
      console.error(`Error writing ${path}:`, err);
    }
  });
}

function updateUserCredits(chatId, amount) {
  const userId = chatId.toString();
  let userData = getUserData(userId);
  let currentCredits = userData.credits || 0;

  // р╕кр╕бр╕бр╕Хр╕┤р╕зр╣Ир╕▓ 1 р╕Ър╕▓р╕Ч = 1 р╣Ар╕Др╕гр╕Фр╕┤р╕Х
  const newCredits = currentCredits + amount;

  userData.credits = newCredits;
  saveUserData(userId, userData);

  bot.sendMessage(chatId, `ЁЯТ░ р╕вр╕нр╕Фр╣Ар╕Др╕гр╕Фр╕┤р╕Хр╕Ыр╕▒р╕Ир╕Ир╕╕р╕Ър╕▒р╕Щр╕Вр╕нр╕Зр╕Др╕╕р╕Ур╕Др╕╖р╕н ${newCredits} р╣Ар╕Др╕гр╕Фр╕┤р╕Х`);
}

// р╣Ар╕Юр╕┤р╣Ир╕бр╕гр╕▓р╕вр╕Бр╕▓р╕гр╕Вр╕нр╕Зр╣Бр╕нр╕Фр╕бр╕┤р╕Щ
const adminIds = [123456789]; // р╣Бр╕Чр╕Щр╕Чр╕╡р╣Ир╕Фр╣Йр╕зр╕в Telegram ID р╕Вр╕нр╕Зр╣Бр╕нр╕Фр╕бр╕┤р╕Щ

// р╕гр╕▒р╕Ър╕Др╕│р╕кр╕▒р╣Ир╕З /start р╕Ир╕▓р╕Бр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Й
bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id;
  const message = 'ЁЯдЦ р╕вр╕┤р╕Щр╕Фр╕╡р╕Хр╣Йр╕нр╕Щр╕гр╕▒р╕Ър╕кр╕╣р╣Ир╕Ър╕нр╕Чр╕кр╕╕р╕Фр╕ер╣Йр╕│! р╕Др╕╕р╕Ур╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Гр╕Кр╣Йр╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Хр╣Ир╕нр╣Др╕Ыр╕Щр╕╡р╣Й:\n\n' +
                  'ЁЯТа /addclient - р╣Ар╕Юр╕┤р╣Ир╕бр╕ер╕╣р╕Бр╕Др╣Йр╕▓р╣Гр╕лр╕бр╣И\n' +
                  'ЁЯТ░ /topup - р╣Ар╕Хр╕┤р╕бр╣Ар╕Зр╕┤р╕Щр╣Ар╕Юр╕╖р╣Ир╕нр╕Лр╕╖р╣Йр╕нр╣Ар╕Др╕гр╕Фр╕┤р╕Х\n' +
                  'ЁЯТ│ /mycredits - р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Ар╕Др╕гр╕Фр╕┤р╕Хр╕Вр╕нр╕Зр╕Др╕╕р╕У\n' +
                  'ЁЯУЭ /mycodes - р╕Фр╕╣р╣Вр╕Др╣Йр╕Фр╕Чр╕╡р╣Ир╕Др╕╕р╕Ур╕кр╕гр╣Йр╕▓р╕З\n\n' +
                  'ЁЯУМ р╣Вр╕Ыр╕гр╕Фр╣Гр╕Кр╣Йр╕Др╕│р╕кр╕▒р╣Ир╕З /topup р╣Ар╕Юр╕╖р╣Ир╕нр╣Ар╕Хр╕┤р╕бр╣Ар╕Др╕гр╕Фр╕┤р╕Хр╕Бр╣Ир╕нр╕Щр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ';
  bot.sendMessage(chatId, message);
});

// р╕гр╕▒р╕Ър╕Др╕│р╕кр╕▒р╣Ир╕З /topup р╕Ир╕▓р╕Бр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Й
bot.onText(/\/topup/, (msg) => {
  const chatId = msg.chat.id;
  if (msg.chat.type === 'private') {
    const message = 'ЁЯТ│ р╕Бр╕гр╕╕р╕Ур╕▓р╕кр╣Ир╕Зр╕ер╕┤р╕Зр╕Бр╣Мр╕Лр╕нр╕Зр╕нр╕▒р╣Ир╕Зр╣Ар╕Ыр╕▓р╕зр╕нр╣Ар╕ер╕Чр╣Ар╕Юр╕╖р╣Ир╕нр╣Ар╕Хр╕┤р╕бр╣Ар╕Др╕гр╕Фр╕┤р╕Хр╕Вр╕нр╕Зр╕Др╕╕р╕У!\n\nЁЯУе р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕З: https://gift.truemoney.com/campaign/?v=xxxxx';
    bot.sendMessage(chatId, message);
  } else {
    bot.sendMessage(chatId, 'тЪая╕П р╕Бр╕гр╕╕р╕Ур╕▓р╣Гр╕Кр╣Йр╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Щр╕╡р╣Йр╣Гр╕Щр╣Бр╕Кр╕Чр╕кр╣Ир╕зр╕Щр╕Хр╕▒р╕зр╕Бр╕▒р╕Ър╕Ър╕нр╕Чр╣Ар╕Чр╣Ир╕▓р╕Щр╕▒р╣Йр╕Щ');
  }
});

// р╕гр╕▒р╕Ър╕Др╕│р╕кр╕▒р╣Ир╕З /mycredits
bot.onText(/\/mycredits/, (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id.toString();
  let userData = getUserData(userId);
  let credits = userData.credits || 0;
  bot.sendMessage(chatId, `ЁЯТ░ р╕вр╕нр╕Фр╣Ар╕Др╕гр╕Фр╕┤р╕Хр╕Ыр╕▒р╕Ир╕Ир╕╕р╕Ър╕▒р╕Щр╕Вр╕нр╕Зр╕Др╕╕р╕Ур╕Др╕╖р╕н ${credits} р╣Ар╕Др╕гр╕Фр╕┤р╕Х`);
});

// р╕гр╕▒р╕Ър╕Др╕│р╕кр╕▒р╣Ир╕З /mycodes
bot.onText(/\/mycodes/, (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id.toString();
  let userData = getUserData(userId);
  if (userData.codes && userData.codes.length > 0) {
    let response = 'ЁЯУЬ р╕Др╕╕р╕Ур╣Др╕Фр╣Йр╕кр╕гр╣Йр╕▓р╕Зр╣Вр╕Др╣Йр╕Фр╕Фр╕▒р╕Зр╕Хр╣Ир╕нр╣Др╕Ыр╕Щр╕╡р╣Й:\n';
    userData.codes.forEach((codeEntry, index) => {
      response += `ЁЯФ╣ ${index + 1}. ${codeEntry.codeName} - р╕кр╕гр╣Йр╕▓р╕Зр╣Ар╕бр╕╖р╣Ир╕н ${codeEntry.creationDate}\n`;
    });
    bot.sendMessage(chatId, response);
  } else {
    bot.sendMessage(chatId, 'тЭМ р╕Др╕╕р╕Ур╕вр╕▒р╕Зр╣Др╕бр╣Ир╣Др╕Фр╣Йр╕кр╕гр╣Йр╕▓р╕Зр╣Вр╕Др╣Йр╕Фр╣Гр╕Фр╣Ж');
  }
});

// р╕гр╕▒р╕Ър╕Др╕│р╕кр╕▒р╣Ир╕З /givecredits р╕кр╕│р╕лр╕гр╕▒р╕Ър╣Бр╕нр╕Фр╕бр╕┤р╕Щ
bot.onText(/\/givecredits/, (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  if (adminIds.includes(userId)) {
    const options = {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'р╣Ар╕Юр╕┤р╣Ир╕бр╣Гр╕лр╣Йр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Й', callback_data: 'givecredits_to_user' }],
          [{ text: 'р╣Ар╕Юр╕┤р╣Ир╕бр╣Гр╕лр╣Йр╕Хр╕▒р╕зр╣Ар╕нр╕З', callback_data: 'givecredits_to_self' }]
        ]
      }
    };
    bot.sendMessage(chatId, 'ЁЯФз р╕Бр╕гр╕╕р╕Ур╕▓р╣Ар╕ер╕╖р╕нр╕Бр╕Хр╕▒р╕зр╣Ар╕ер╕╖р╕нр╕Б:', options);
  } else {
    bot.sendMessage(chatId, 'ЁЯЪл р╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Щр╕╡р╣Йр╕кр╕│р╕лр╕гр╕▒р╕Ър╣Бр╕нр╕Фр╕бр╕┤р╕Щр╣Ар╕Чр╣Ир╕▓р╕Щр╕▒р╣Йр╕Щ');
  }
});

// р╕гр╕▒р╕Ър╕Др╕│р╕кр╕▒р╣Ир╕З /allcodes р╕кр╕│р╕лр╕гр╕▒р╕Ър╣Бр╕нр╕Фр╕бр╕┤р╕Щ
bot.onText(/\/allcodes/, (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  if (adminIds.includes(userId)) {
    let response = 'ЁЯУД р╕гр╕▓р╕вр╕Бр╕▓р╕гр╣Вр╕Др╣Йр╕Фр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф:\n';
    for (let uid in usersData) {
      if (usersData[uid].codes && usersData[uid].codes.length > 0) {
        response += `ЁЯСд р╕Ьр╕╣р╣Йр╣Гр╕Кр╣Й ${uid}:\n`;
        usersData[uid].codes.forEach((codeEntry, index) => {
          response += ` - ${codeEntry.codeName}: ${codeEntry.code}\n`;
        });
      }
    }
    bot.sendMessage(chatId, response);
  } else {
    bot.sendMessage(chatId, 'ЁЯЪл р╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Щр╕╡р╣Йр╕кр╕│р╕лр╕гр╕▒р╕Ър╣Бр╕нр╕Фр╕бр╕┤р╕Щр╣Ар╕Чр╣Ир╕▓р╕Щр╕▒р╣Йр╕Щ');
  }
});

// р╕гр╕▒р╕Ър╕Др╕│р╕кр╕▒р╣Ир╕З /addclient
bot.onText(/\/addclient/, (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;

  // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╣Ар╕Ыр╣Зр╕Щр╕Бр╕ер╕╕р╣Ир╕бр╕Чр╕╡р╣Ир╕Бр╕│р╕лр╕Щр╕Фр╕лр╕гр╕╖р╕нр╣Др╕бр╣И
  if (chatId === -1002344075247) {
    // р╕кр╣Ир╕Зр╕Ыр╕╕р╣Ир╕б 'TRUE PRO р╣Ар╕Яр╕кр╕Ър╕╕р╕Д'
    const options = {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'ЁЯЪА TRUE PRO р╣Ар╕Яр╕кр╕Ър╕╕р╕Д', callback_data: 'true_pro_facebook' }]
        ]
      }
    };
    bot.sendMessage(chatId, 'ЁЯФН р╕Бр╕гр╕╕р╕Ур╕▓р╣Ар╕ер╕╖р╕нр╕Бр╣Вр╕Ыр╕гр╣Др╕Яр╕ер╣Мр╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕г:', options);
  } else {
    bot.sendMessage(chatId, 'тЪая╕П р╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Щр╕╡р╣Йр╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Гр╕Кр╣Йр╣Др╕Фр╣Йр╣Ар╕Йр╕Юр╕▓р╕░р╣Гр╕Щр╕Бр╕ер╕╕р╣Ир╕бр╕Чр╕╡р╣Ир╕Бр╕│р╕лр╕Щр╕Фр╣Ар╕Чр╣Ир╕▓р╕Щр╕▒р╣Йр╕Щ');
  }
});

// р╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╕Бр╕▓р╕гр╕Бр╕Фр╕Ыр╕╕р╣Ир╕б
bot.on('callback_query', (callbackQuery) => {
  const chatId = callbackQuery.message.chat.id;
  const userId = callbackQuery.from.id;
  const data = callbackQuery.data;

  if (data === 'true_pro_facebook') {
    // р╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щр╕Бр╕▓р╕гр╕кр╕Щр╕Чр╕Щр╕▓р╣Ар╕Юр╕╖р╣Ир╕нр╣Ар╕Бр╣Зр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕е
    userSessions[userId] = { step: 'ask_code_name' };

    bot.sendMessage(chatId, 'ЁЯУЭ р╕Бр╕гр╕╕р╕Ур╕▓р╕Хр╕▒р╣Йр╕Зр╕Кр╕╖р╣Ир╕нр╣Вр╕Др╣Йр╕Фр╕Вр╕нр╕Зр╕Др╕╕р╕У');
  } else if (data === 'givecredits_to_user') {
    if (adminIds.includes(userId)) {
      userSessions[userId] = { step: 'givecredits_ask_user' };
      bot.sendMessage(chatId, 'ЁЯФН р╕Бр╕гр╕╕р╕Ур╕▓р╕Хр╕нр╕Ър╕Бр╕ер╕▒р╕Ър╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Вр╕нр╕Зр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╣Ар╕Юр╕┤р╣Ир╕бр╣Ар╕Др╕гр╕Фр╕┤р╕Хр╣Гр╕лр╣Й');
    } else {
      bot.answerCallbackQuery(callbackQuery.id, 'ЁЯЪл р╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Щр╕╡р╣Йр╕кр╕│р╕лр╕гр╕▒р╕Ър╣Бр╕нр╕Фр╕бр╕┤р╕Щр╣Ар╕Чр╣Ир╕▓р╕Щр╕▒р╣Йр╕Щ');
    }
  } else if (data === 'givecredits_to_self') {
    if (adminIds.includes(userId)) {
      userSessions[userId] = { step: 'givecredits_ask_amount', targetUserId: userId };
      bot.sendMessage(chatId, 'ЁЯТ░ р╕Бр╕гр╕╕р╕Ур╕▓р╕гр╕░р╕Ър╕╕р╕Ир╕│р╕Щр╕зр╕Щр╣Ар╕Др╕гр╕Фр╕┤р╕Хр╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╣Ар╕Юр╕┤р╣Ир╕бр╣Гр╕лр╣Йр╕Хр╕▒р╕зр╣Ар╕нр╕З');
    } else {
      bot.answerCallbackQuery(callbackQuery.id, 'ЁЯЪл р╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Щр╕╡р╣Йр╕кр╕│р╕лр╕гр╕▒р╕Ър╣Бр╕нр╕Фр╕бр╕┤р╕Щр╣Ар╕Чр╣Ир╕▓р╕Щр╕▒р╣Йр╕Щ');
    }
  }
});

// р╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Ир╕▓р╕Бр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Й
bot.on('message', (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  const text = msg.text;

  // р╕лр╕▓р╕Бр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╕нр╕вр╕╣р╣Ир╣Гр╕Щр╕кр╕Цр╕▓р╕Щр╕░р╕Бр╕▓р╕гр╕кр╕Щр╕Чр╕Щр╕▓
  if (userSessions[userId]) {
    const session = userSessions[userId];

    // р╣Ар╕Бр╣Зр╕Ъ message IDs
    if (!session.messageIds) {
      session.messageIds = [];
    }
    session.messageIds.push(msg.message_id);

    if (session.step === 'ask_code_name') {
      // р╣Ар╕Бр╣Зр╕Ър╕Кр╕╖р╣Ир╕нр╣Вр╕Др╣Йр╕Ф
      session.codeName = text;
      session.step = 'ask_days';
      bot.sendMessage(chatId, 'ЁЯУЕ р╕Бр╕гр╕╕р╕Ур╕▓р╣Ар╕ер╕╖р╕нр╕Бр╕Ир╕│р╕Щр╕зр╕Щр╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕г (1-30 р╕зр╕▒р╕Щ)');
    } else if (session.step === 'ask_days') {
      const days = parseInt(text);
      if (isNaN(days) || days <= 0 || days > 30) {
        bot.sendMessage(chatId, 'тЪая╕П р╕Бр╕гр╕╕р╕Ур╕▓р╕гр╕░р╕Ър╕╕р╕Ир╕│р╕Щр╕зр╕Щр╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З (1-30 р╕зр╕▒р╕Щ)');
      } else {
        session.days = days;
        session.step = 'ask_gb_limit';
        bot.sendMessage(chatId, 'ЁЯТ╛ р╕Бр╕гр╕╕р╕Ур╕▓р╕гр╕░р╕Ър╕╕ GB р╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╕Ир╕│р╕Бр╕▒р╕Ф (р╕лр╕▓р╕Бр╣Др╕бр╣Ир╕Ир╕│р╕Бр╕▒р╕Фр╕Юр╕┤р╕бр╕Юр╣М 0)');
      }
    } else if (session.step === 'ask_gb_limit') {
      const gbLimit = parseInt(text);
      if (isNaN(gbLimit) || gbLimit < 0) {
        bot.sendMessage(chatId, 'тЪая╕П р╕Бр╕гр╕╕р╕Ур╕▓р╕гр╕░р╕Ър╕╕р╕Ир╕│р╕Щр╕зр╕Щ GB р╕Чр╕╡р╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З');
      } else {
        session.gbLimit = gbLimit;
        session.step = 'creating_code';
        bot.sendMessage(chatId, 'тП│ р╕Бр╕│р╕ер╕▒р╕Зр╕кр╕гр╣Йр╕▓р╕Зр╣Вр╕Др╣Йр╕Фр╕Вр╕нр╕Зр╕Др╕╕р╕У р╣Вр╕Ыр╕гр╕Фр╕гр╕нр╕кр╕▒р╕Бр╕Др╕гр╕╣р╣И...');

        // р╕кр╣Ир╕З GIF
        const gifUrl = "https://i.imgur.com/DnLmp0s.gif";
        bot.sendAnimation(chatId, gifUrl);

        // р╕кр╕гр╣Йр╕▓р╕Зр╣Вр╕Др╣Йр╕Фр╕лр╕ер╕▒р╕Зр╕Ир╕▓р╕Б 4 р╕зр╕┤р╕Щр╕▓р╕Чр╕╡
        setTimeout(() => {
          const userIdStr = userId.toString();
          let userData = getUserData(userIdStr);
          let currentCredits = userData.credits || 0;

          const requiredCredits = session.days;

          if (currentCredits >= requiredCredits) {
            // р╕лр╕▒р╕Бр╣Ар╕Др╕гр╕Фр╕┤р╕Хр╣Бр╕ер╕░р╣Ар╕Юр╕┤р╣Ир╕бр╕ер╕╣р╕Бр╕Др╣Йр╕▓р╣Гр╕лр╕бр╣И
            const newCredits = currentCredits - requiredCredits;

            userData.credits = newCredits;
            saveUserData(userIdStr, userData);

            // р╕Чр╕│р╕Бр╕▓р╕гр╣Ар╕Юр╕┤р╣Ир╕бр╕ер╕╣р╕Бр╕Др╣Йр╕▓р╣Гр╕лр╕бр╣И
            login(() => {
              addNewClient(session, (clientCode) => {
                // р╕кр╣Ир╕Зр╣Вр╕Др╣Йр╕Фр╣Др╕Ыр╕вр╕▒р╕Зр╣Бр╕Кр╕Чр╕кр╣Ир╕зр╕Щр╕Хр╕▒р╕зр╕Вр╕нр╕Зр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Й
                sendCodeToUser(userId, chatId, clientCode, session, msg);
                // delete userSessions[userId]; // Will be deleted in sendCodeToUser
              }, (errorMsg) => {
                bot.sendMessage(chatId, 'ЁЯЪл р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╕кр╕гр╣Йр╕▓р╕Зр╣Вр╕Др╣Йр╕Ф: ' + errorMsg);
                delete userSessions[userId];
              });
            });
          } else {
            bot.sendMessage(chatId, `тЪая╕П р╣Ар╕Др╕гр╕Фр╕┤р╕Хр╕Вр╕нр╕Зр╕Др╕╕р╕Ур╣Др╕бр╣Ир╣Ар╕Юр╕╡р╕вр╕Зр╕Юр╕н р╕Др╕╕р╕Ур╕бр╕╡ ${currentCredits} р╣Ар╕Др╕гр╕Фр╕┤р╕Х р╣Бр╕Хр╣Ир╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕г ${requiredCredits} р╣Ар╕Др╕гр╕Фр╕┤р╕Х\nр╣Вр╕Ыр╕гр╕Фр╣Ар╕Хр╕┤р╕бр╣Ар╕Др╕гр╕Фр╕┤р╕Хр╣Вр╕Фр╕вр╣Гр╕Кр╣Йр╕Др╕│р╕кр╕▒р╣Ир╕З /topup`);
            delete userSessions[userId];
          }
        }, 4000); // р╕гр╕н 4 р╕зр╕┤р╕Щр╕▓р╕Чр╕╡р╣Ар╕Юр╕╖р╣Ир╕нр╕Ир╕│р╕ер╕нр╕Зр╣Ар╕зр╕ер╕▓р╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕е
      }
    } else if (session.step === 'givecredits_ask_user') {
      if (msg.reply_to_message && msg.reply_to_message.from) {
        const targetUserId = msg.reply_to_message.from.id;
        session.targetUserId = targetUserId;
        session.step = 'givecredits_ask_amount';
        bot.sendMessage(chatId, 'ЁЯТ░ р╕Бр╕гр╕╕р╕Ур╕▓р╕гр╕░р╕Ър╕╕р╕Ир╕│р╕Щр╕зр╕Щр╣Ар╕Др╕гр╕Фр╕┤р╕Хр╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╣Ар╕Юр╕┤р╣Ир╕бр╣Гр╕лр╣Йр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Й');
      } else {
        bot.sendMessage(chatId, 'тЪая╕П р╕Бр╕гр╕╕р╕Ур╕▓р╕Хр╕нр╕Ър╕Бр╕ер╕▒р╕Ър╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Вр╕нр╕Зр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╣Ар╕Юр╕┤р╣Ир╕бр╣Ар╕Др╕гр╕Фр╕┤р╕Хр╣Гр╕лр╣Й');
      }
    } else if (session.step === 'givecredits_ask_amount') {
      const amount = parseInt(text);
      if (isNaN(amount) || amount <= 0) {
        bot.sendMessage(chatId, 'тЪая╕П р╕Бр╕гр╕╕р╕Ур╕▓р╕гр╕░р╕Ър╕╕р╕Ир╕│р╕Щр╕зр╕Щр╣Ар╕Др╕гр╕Фр╕┤р╕Хр╕Чр╕╡р╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З');
      } else {
        const targetUserId = session.targetUserId.toString();
        let targetUserData = getUserData(targetUserId);
        let currentCredits = targetUserData.credits || 0;
        targetUserData.credits = currentCredits + amount;
        saveUserData(targetUserId, targetUserData);

        bot.sendMessage(chatId, `тЬЕ р╣Ар╕Юр╕┤р╣Ир╕бр╣Ар╕Др╕гр╕Фр╕┤р╕Хр╣Гр╕лр╣Йр╕Бр╕▒р╕Ър╕Ьр╕╣р╣Йр╣Гр╕Кр╣Й ${targetUserId} р╕Ир╕│р╕Щр╕зр╕Щ ${amount} р╣Ар╕Др╕гр╕Фр╕┤р╕Хр╣Бр╕ер╣Йр╕з`);

        if (targetUserId !== userId.toString()) {
          // Notify target user in private chat
          bot.sendMessage(targetUserId, `ЁЯТ░ р╕Др╕╕р╕Ур╣Др╕Фр╣Йр╕гр╕▒р╕Ър╣Ар╕Др╕гр╕Фр╕┤р╕Хр╣Ар╕Юр╕┤р╣Ир╕б ${amount} р╣Ар╕Др╕гр╕Фр╕┤р╕Х р╕Ир╕▓р╕Бр╣Бр╕нр╕Фр╕бр╕┤р╕Щ`);
        }
        delete userSessions[userId];
      }
    }
  } else if (msg.chat.type === 'private') {
    // р╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╣Гр╕Щр╣Бр╕Кр╕Чр╕кр╣Ир╕зр╕Щр╕Хр╕▒р╕з

    // р╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╕ер╕┤р╕Зр╕Бр╣Мр╕Лр╕нр╕Зр╕нр╕▒р╣Ир╕Зр╣Ар╕Ыр╕▓
    if (text && text.includes('https://gift.truemoney.com/campaign/?v=')) {
      // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕бр╕╡р╕ер╕┤р╕Зр╕Бр╣Мр╕Лр╕нр╕Зр╕нр╕▒р╣Ир╕Зр╣Ар╕Ыр╕▓р╕лр╕гр╕╖р╕нр╣Др╕бр╣И
      const codeMatch = text.match(/v=([a-zA-Z0-9]+)/);
      if (codeMatch && codeMatch[1]) {
        const code = codeMatch[1];

        // р╕Чр╕│р╕Бр╕▓р╕гр╣Ар╕гр╕╡р╕вр╕Б API р╣Ар╕Юр╕╖р╣Ир╕нр╕гр╕▒р╕Ър╣Ар╕Зр╕┤р╕Щ
        processTrueMoneyGiftCode(chatId, code);
      } else {
        bot.sendMessage(chatId, 'тЪая╕П р╕ер╕┤р╕Зр╕Бр╣Мр╣Др╕бр╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З р╣Вр╕Ыр╕гр╕Фр╕кр╣Ир╕Зр╕ер╕┤р╕Зр╕Бр╣Мр╕Лр╕нр╕Зр╕нр╕▒р╣Ир╕Зр╣Ар╕Ыр╕▓р╕зр╕нр╣Ар╕ер╕Чр╕Чр╕╡р╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З');
      }
    }
  } else {
    // р╣Др╕бр╣Ир╕Хр╕нр╕Ър╕кр╕Щр╕нр╕Зр╕Хр╣Ир╕нр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕нр╕╖р╣Ир╕Щр╣Ж р╣Гр╕Щр╕Бр╕ер╕╕р╣Ир╕б
    if (text && !text.startsWith('/')) {
      bot.sendMessage(chatId, 'тЭУ р╣Др╕бр╣Ир╣Ар╕Вр╣Йр╕▓р╣Гр╕Ир╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Вр╕нр╕Зр╕Др╕╕р╕У р╣Вр╕Ыр╕гр╕Фр╣Гр╕Кр╣Йр╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Чр╕╡р╣Ир╕Бр╕│р╕лр╕Щр╕Ф');
    }
  }
});

// р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╕кр╕│р╕лр╕гр╕▒р╕Ър╕кр╣Ир╕Зр╣Вр╕Др╣Йр╕Фр╣Др╕Ыр╕вр╕▒р╕Зр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Й
function sendCodeToUser(userId, chatId, clientCode, session, msg) {
  // р╕кр╣Ир╕Зр╣Вр╕Др╣Йр╕Фр╣Др╕Ыр╕вр╕▒р╕Зр╣Бр╕Кр╕Чр╕кр╣Ир╕зр╕Щр╕Хр╕▒р╕зр╕Вр╕нр╕Зр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Й
  bot.sendMessage(userId, `тЬЕ р╣Вр╕Др╣Йр╕Фр╕Вр╕нр╕Зр╕Др╕╕р╕Ур╕Цр╕╣р╕Бр╕кр╕гр╣Йр╕▓р╕Зр╕кр╕│р╣Ар╕гр╣Зр╕И!\n\nЁЯУм р╕Бр╕гр╕╕р╕Ур╕▓р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Вр╕Др╣Йр╕Фр╕Вр╕нр╕Зр╕Др╕╕р╕Ур╕Фр╣Йр╕▓р╕Щр╕ер╣Ир╕▓р╕З:\n\n${clientCode}`)
    .then(() => {
      // р╕лр╕ер╕▒р╕Зр╕Ир╕▓р╕Бр╕кр╣Ир╕Зр╣Вр╕Др╣Йр╕Фр╕кр╕│р╣Ар╕гр╣Зр╕И р╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Ьр╕╣р╣Йр╣Гр╕Кр╣Й
      const userIdStr = userId.toString();
      let userData = getUserData(userIdStr);
      if (!userData.codes) {
        userData.codes = [];
      }
      userData.codes.push({
        code: clientCode,
        codeName: session.codeName,
        creationDate: new Date().toLocaleString()
      });
      saveUserData(userIdStr, userData);

      // р╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щр╣Гр╕Щр╕Бр╕ер╕╕р╣Ир╕б
      bot.sendMessage(chatId, 'тЬЕ р╣Вр╕Др╣Йр╕Фр╕Вр╕нр╕Зр╕Др╕╕р╕Ур╕Цр╕╣р╕Бр╕кр╣Ир╕Зр╣Др╕Ыр╕вр╕▒р╕Зр╣Бр╕Кр╕Чр╕кр╣Ир╕зр╕Щр╕Хр╕▒р╕зр╣Бр╕ер╣Йр╕з! р╣Вр╕Ыр╕гр╕Фр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Бр╕Кр╕Чр╕кр╣Ир╕зр╕Щр╕Хр╕▒р╕зр╕Вр╕нр╕Зр╕Др╕╕р╕У ЁЯУм');

      // р╕ер╕Ър╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╣Гр╕Щр╕Бр╕▓р╕гр╕кр╕Щр╕Чр╕Щр╕▓
      if (session && session.messageIds) {
        session.messageIds.forEach((messageId) => {
          bot.deleteMessage(chatId, messageId).catch((error) => {
            console.error('Error deleting message:', error);
          });
        });
      }
      delete userSessions[userId];
    })
    .catch((error) => {
      if (error.response && error.response.statusCode === 403) {
        // р╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╕вр╕▒р╕Зр╣Др╕бр╣Ир╣Др╕Фр╣Йр╣Ар╕гр╕┤р╣Ир╕бр╣Бр╕Кр╕Чр╕Бр╕▒р╕Ър╕Ър╕нр╕Ч
        const options = {
          reply_markup: {
            inline_keyboard: [
              [{ text: 'р╣Ар╕гр╕┤р╣Ир╕бр╣Бр╕Кр╕Чр╕Бр╕▒р╕Ър╕Ър╕нр╕Ч', url: `https://t.me/${botUsername}?start` }]
            ]
          }
        };
        const username = msg.from.username ? `@${msg.from.username}` : msg.from.first_name;
        // р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╣Гр╕Щр╕Бр╕ер╕╕р╣Ир╕б
        bot.sendMessage(chatId, `${username} р╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕Фр╕Ыр╕╕р╣Ир╕бр╕Фр╣Йр╕▓р╕Щр╕ер╣Ир╕▓р╕Зр╣Ар╕Юр╕╖р╣Ир╕нр╣Ар╕гр╕┤р╣Ир╕бр╣Бр╕Кр╕Чр╕кр╣Ир╕зр╕Щр╕Хр╕▒р╕зр╕Бр╕▒р╕Ър╕Ър╕нр╕Ч`, options);
      } else {
        console.error('Error sending code to user:', error);
      }
    });
}
